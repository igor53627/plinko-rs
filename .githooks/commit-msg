#!/usr/bin/env bash
#
# commit-msg hook: validates Conventional Commits format.
#
# Allowed types: feat, fix, perf, docs, chore, ci, test, refactor, style, build, revert
# Format:        <type>[(<scope>)][!]: <description>
# Subject line:  max 72 characters
#
# Exemptions: merge commits, fixup/squash prefixes, "bd sync" messages.

set -euo pipefail

commit_msg_file="$1"
msg=$(head -1 "$commit_msg_file")

# --- Exemptions ---

case "$msg" in
  Merge\ *|fixup!\ *|squash!\ *|bd\ sync*)
    exit 0
    ;;
esac

# --- Validation ---

TYPES="feat|fix|perf|docs|chore|ci|test|refactor|style|build|revert"

# Check Conventional Commits format: type[(scope)][!]: description
if ! printf '%s\n' "$msg" | grep -qE "^($TYPES)(\([a-zA-Z0-9_/ -]+\))?!?: .+"; then
  printf '%s\n' "ERROR: commit message does not follow Conventional Commits format."
  printf '\n'
  printf '%s\n' "  Expected: <type>[(<scope>)][!]: <description>"
  printf '%s\n' "  Types:    feat, fix, perf, docs, chore, ci, test, refactor, style, build, revert"
  printf '\n'
  printf '%s\n' "  Examples:"
  printf '%s\n' "    feat: add new hints generator"
  printf '%s\n' "    fix(iprf): correct domain size"
  printf '%s\n' "    docs: update README"
  printf '\n'
  printf '  Got: %s\n' "$msg"
  exit 1
fi

# Check subject line length (max 72 chars)
len=${#msg}
if [ "$len" -gt 72 ]; then
  printf 'ERROR: commit subject line is %s characters (max 72).\n' "$len"
  printf '\n'
  printf '  Subject: %s\n' "$msg"
  exit 1
fi

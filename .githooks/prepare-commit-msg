#!/usr/bin/env bash
#
# prepare-commit-msg hook: normalizes commit messages before the
# commit-msg validator runs. Fixes common formatting issues in-place
# so contributors don't have to re-commit.
#
# Normalizations applied (to subject line only):
#   1. Lowercase the type prefix        (Feat: -> feat:)
#   2. Expand type aliases               (feature -> feat, bugfix/hotfix -> fix, doc -> docs)
#   3. Insert space after colon if missing (feat:add -> feat: add)
#
# Exemptions: merge commits, fixup!/squash! prefixes, "bd sync" messages.

set -euo pipefail

commit_msg_file="$1"
msg=$(head -1 "$commit_msg_file")

# --- Exemptions (must match commit-msg hook) ---

case "$msg" in
  Merge\ *|fixup!\ *|squash!\ *|bd\ sync*)
    exit 0
    ;;
esac

# --- Normalization ---

# 1. Lowercase type prefix (everything before the first colon, paren, or bang)
#    Handles: Feat: -> feat:, CHORE(scope): -> chore(scope):
#    Uses awk for portable lowercase (no GNU sed \L dependency)
msg=$(printf '%s\n' "$msg" | awk '{
  match($0, /^[A-Za-z]+/)
  if (RSTART == 1) {
    prefix = substr($0, 1, RLENGTH)
    rest = substr($0, RLENGTH + 1)
    print tolower(prefix) rest
  } else {
    print
  }
}')

# 2. Expand type aliases
msg=$(printf '%s\n' "$msg" | sed -E 's/^feature([(:!])/feat\1/')
msg=$(printf '%s\n' "$msg" | sed -E 's/^(bugfix|hotfix)([(:!])/fix\2/')
msg=$(printf '%s\n' "$msg" | sed -E 's/^doc([(:!])/docs\1/')

# 3. Fix missing space after colon: "feat:add" -> "feat: add"
msg=$(printf '%s\n' "$msg" | sed -E 's/^([a-z]+(\([a-zA-Z0-9_/ -]+\))?!?:)([^ ])/\1 \3/')

# Write normalized subject while preserving body/trailers.
tmp_file="$(mktemp "${commit_msg_file}.tmp.XXXXXX")"
{
  printf '%s\n' "$msg"
  tail -n +2 "$commit_msg_file"
} > "$tmp_file"
mv "$tmp_file" "$commit_msg_file"

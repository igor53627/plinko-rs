name: Formal Verification

on:
  push:
    branches: [main]
    paths:
      - 'plinko/formal/**'
      - 'state-syncer/src/**'
      - 'state-syncer/Cargo.toml'
      - 'Cargo.toml'
      - '.github/workflows/formal.yml'
  pull_request:
    branches: [main]
    paths:
      - 'plinko/formal/**'
      - 'state-syncer/src/**'
      - 'state-syncer/Cargo.toml'
      - 'Cargo.toml'
      - '.github/workflows/formal.yml'

env:
  OPAMYES: 1
  OPAMJOBS: 2

jobs:
  rocq-proofs:
    name: Rocq Proofs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Cache opam
        id: cache-opam
        uses: actions/cache@v4
        with:
          path: ~/.opam
          key: opam-rocq9-${{ runner.os }}-v2-${{ hashFiles('plinko/formal/Makefile', '.github/workflows/formal.yml') }}
          restore-keys: |
            opam-rocq9-${{ runner.os }}-v2-
            opam-rocq9-${{ runner.os }}-

      - name: Install opam
        run: |
          sudo apt-get update
          sudo apt-get install -y opam

      - name: Setup opam and Rocq 9.0
        if: steps.cache-opam.outputs.cache-hit != 'true'
        run: |
          opam init --auto-setup --disable-sandboxing --bare
          opam switch create rocq-9 ocaml-base-compiler.4.14.2 || opam switch set rocq-9
          eval $(opam env --switch=rocq-9)
          opam repo add coq-released https://coq.inria.fr/opam/released || true
          opam update
          opam install -y rocq-prover.9.0.0 rocq-stdlib.9.0.0

      - name: Configure opam environment
        run: |
          echo "/home/runner/.opam/rocq-9/bin" >> $GITHUB_PATH
          # Debug: show available binaries
          echo "Available binaries in opam switch:"
          ls -la /home/runner/.opam/rocq-9/bin/ 2>/dev/null | grep -E "rocq|coq" | head -20 || echo "(bin dir not found)"
          # Create compatibility symlinks (Rocq 9.x uses 'rocq' binary with subcommands)
          # rocq compile = coqc, rocq dep = coqdep, rocq makefile = coq_makefile
          ln -sf /home/runner/.opam/rocq-9/bin/rocq /home/runner/.opam/rocq-9/bin/coqc || true
          ln -sf /home/runner/.opam/rocq-9/bin/rocq /home/runner/.opam/rocq-9/bin/rocqc || true
          ln -sf /home/runner/.opam/rocq-9/bin/rocq /home/runner/.opam/rocq-9/bin/coqdep || true
          ln -sf /home/runner/.opam/rocq-9/bin/rocq /home/runner/.opam/rocq-9/bin/rocqdep || true

      - name: Verify Rocq installation
        run: |
          echo "Checking rocq binary..."
          which rocq || echo "rocq not found"
          rocq --version || echo "rocq --version failed"
          # Verify compile subcommand works
          rocq compile --version || rocq -v || echo "rocq compile check failed"

      - name: Build Rocq specs and proofs
        run: |
          cd plinko/formal
          make clean
          make all

      - name: Run audit
        run: |
          cd plinko/formal
          make audit

      - name: Check admits threshold
        run: |
          cd plinko/formal
          make check-admits ADMIT_THRESHOLD=10

      - name: Verify axioms
        run: |
          cd plinko/formal
          make verify-axioms

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plinko-audit
          path: plinko/formal/artifacts/audit.txt
          retention-days: 30

      - name: Build Summary
        if: always()
        run: |
          cd plinko/formal
          ADMITS=$(make -s admit-count 2>/dev/null || echo "?")
          {
            echo "## Plinko Formal Verification Summary"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
            echo "| Specs | ${{ job.status == 'success' && '[OK]' || '[FAIL]' }} |"
            echo "| Sims | ${{ job.status == 'success' && '[OK]' || '[FAIL]' }} |"
            echo "| Proofs | ${{ job.status == 'success' && '[OK]' || '[FAIL]' }} |"
            echo "| Admits | ${ADMITS} (threshold: 10) |"
            echo ""
            echo "### Audit Report"
            echo '```'
            cat artifacts/audit.txt 2>/dev/null || echo "(not generated)"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

  rocq-of-rust:
    name: Rocq-of-Rust Translation
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Cache opam
        id: cache-opam-ror
        uses: actions/cache@v4
        with:
          path: ~/.opam
          # v4: removed optional deps (hammer, smpl, coqutil) - now handled in fork
          key: opam-rocq9-ror-${{ runner.os }}-v4-${{ hashFiles('plinko/formal/Makefile', '.github/workflows/formal.yml') }}
          restore-keys: |
            opam-rocq9-ror-${{ runner.os }}-v4-

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-ror-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-ror-${{ runner.os }}-

      - name: Cache rocq-of-rust
        id: cache-ror
        uses: actions/cache@v4
        with:
          path: ~/rocq-of-rust
          # v11: fork with non-dependent sigS for Closure
          key: rocq-of-rust-fork-${{ runner.os }}-v11
          restore-keys: |
            rocq-of-rust-fork-${{ runner.os }}-v11

      - name: Install opam
        run: |
          sudo apt-get update
          sudo apt-get install -y opam

      - name: Setup opam and Rocq 9.0
        if: steps.cache-opam-ror.outputs.cache-hit != 'true'
        run: |
          opam init --auto-setup --disable-sandboxing --bare
          opam switch create rocq-9 ocaml-base-compiler.4.14.2 || opam switch set rocq-9
          eval $(opam env --switch=rocq-9)
          opam repo add coq-released https://coq.inria.fr/opam/released || true
          opam update
          # Install Rocq 9.0 (optional deps removed from fork's M.v)
          opam install -y rocq-prover.9.0.0 rocq-stdlib.9.0.0

      - name: Configure opam environment
        run: |
          echo "/home/runner/.opam/rocq-9/bin" >> $GITHUB_PATH
          # Debug: show available binaries
          echo "Available binaries in opam switch:"
          ls -la /home/runner/.opam/rocq-9/bin/ 2>/dev/null | grep -E "rocq|coq" | head -20 || echo "(bin dir not found)"
          # Do NOT create symlinks - rocq-prover.9.0.0 already provides coq* binaries
          # Symlinks would overwrite working binaries with broken rocq symlinks

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2024-12-07
          components: rustc-dev, llvm-tools-preview

      - name: Clone and build rocq-of-rust
        run: |
          FORK_URL="https://github.com/igor53627/rocq-of-rust.git"
          FORK_BRANCH="fix/rocq-9x-cli-support"
          
          if [ -d ~/rocq-of-rust ]; then
            cd ~/rocq-of-rust
            # Check if this is our fork or the old upstream
            if ! git remote get-url origin | grep -q "igor53627"; then
              echo "Cached repo is old upstream, removing..."
              cd ~ && rm -rf ~/rocq-of-rust
            fi
          fi
          
          if [ ! -d ~/rocq-of-rust ]; then
            echo "Cloning fork..."
            git clone "$FORK_URL" ~/rocq-of-rust
          fi
          
          cd ~/rocq-of-rust
          git fetch origin "$FORK_BRANCH"
          git checkout "origin/$FORK_BRANCH"
          
          if [ ! -f target/release/rocq-of-rust ]; then
            echo "Building rocq-of-rust..."
            cargo +nightly-2024-12-07 build --release
          else
            echo "Using cached rocq-of-rust binary"
          fi

      - name: Build RocqOfRust library
        run: |
          cd ~/rocq-of-rust/RocqOfRust
          # Always rebuild if Makefile changed (fork has Rocq 9.x fix)
          echo "Building RocqOfRust library..."
          make -j2 || make

      - name: Translate Rust to Rocq
        id: translate
        run: |
          export PATH="$HOME/rocq-of-rust/target/release:$PATH"
          cd plinko/formal
          make translate

      - name: Build proofs and linking layer
        id: linking
        run: |
          cd plinko/formal
          make clean
          make ROCQOFRUST_PATH="$HOME/rocq-of-rust/RocqOfRust" all
          make ROCQOFRUST_PATH="$HOME/rocq-of-rust/RocqOfRust" linking



name: Kani Formal Verification

on:
  # Only run on push to main (not PRs) for security - self-hosted runner
  push:
    branches: [main]
    paths:
      - 'state-syncer/src/iprf.rs'
      - 'state-syncer/src/kani_proofs.rs'
  workflow_dispatch:

jobs:
  kani:
    runs-on: self-hosted
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        run: |
          if ! command -v rustup &> /dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          fi
          source "$HOME/.cargo/env"
          rustup default stable

      - name: Install Kani (if needed)
        run: |
          source "$HOME/.cargo/env"
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani proofs
        working-directory: state-syncer
        run: |
          source "$HOME/.cargo/env"
          # Run only binomial_sample harnesses (pure arithmetic, no crypto deps)
          cargo kani --harness proof_binomial_sample_bounded --output-format terse
          cargo kani --harness proof_binomial_sample_zero_denom --output-format terse
          cargo kani --harness proof_binomial_sample_matches_coq --output-format terse

  proptest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run proptest harnesses
        working-directory: state-syncer
        run: |
          cargo test --lib kani_proofs -- --nocapture
